(function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};Joosy.Form=function(a){function c(a,b){var c,d,e=this;null==b&&(b={}),Object.isFunction(b)?this.success=b:Object.each(b,function(a,b){return e[a]=b}),this.$container=$(a),0!==this.$container.length&&(this.__assignElements(),this.__delegateEvents(),c=null!=(d=this.$container.get(0).getAttribute("method"))?d.toLowerCase():void 0,c&&!["get","post"].any(c)&&(this.__markMethod(c),this.$container.attr("method","POST")),this.$container.ajaxForm({dataType:"json",beforeSend:function(){return e.__debounce.apply(e,arguments)?!1:(e.__before.apply(e,arguments),e.__pending_request=!0,e.debugAs(e,"beforeSend: pending_request = true"),!0)},success:function(){return e.__pending_request=!1,e.debugAs(e,"success: pending_request = false"),e.__success.apply(e,arguments)},error:function(){return e.__pending_request=!1,e.debugAs(e,"error: pending_request = false"),e.__error.apply(e,arguments)},xhr:function(){var a;return a=$.ajaxSettings.xhr(),null!=a.upload&&e.progress&&(a.upload.onprogress=function(a){return a.lengthComputable?e.progress((100*(a.position/a.total)).round(2)):void 0}),a}}),null!=this.resource&&(this.fill(this.resource,b),delete this.resource),null!=this.action&&(this.$container.attr("action",this.action),this.$container.attr("method","POST")),null!=this.method&&this.__markMethod(this.method))}return b(c,a),c.include(Joosy.Modules.DOM),c.include(Joosy.Modules.Log),c.include(Joosy.Modules.Events),c.prototype.invalidationClass="field_with_errors",c.prototype.substitutions={},c.mapElements({fields:"input,select,textarea"}),c.submit=function(a,b){return null==b&&(b={}),a=new this(a,b),a.$container.submit(),a.unbind(),null},c.attach=function(){return function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return Object(e)===e?e:d}(Joosy.Form,arguments,function(){})},c.prototype.unbind=function(){return this.$container.unbind("submit").find("input:submit,input:image,button:submit").unbind("click")},c.prototype.fill=function(a,b){var c,d,e,f=this;return Object.isFunction(a.build)&&(a=a.build()),this.__resource=a,c=null!=(null!=b?b.decorator:void 0)?b.decorator(a.data):a.data,d=function(a,b){return a.__joosy_form_filler_lock?void 0:(a.__joosy_form_filler_lock=!0,Object.each(a,function(a,c){var e,g,h,i,j,k,l;if(i=f.concatFieldName(b,a),h=f.$fields().filter("[name='"+i+"']:not(:file),[name='"+i.underscore()+"']:not(:file),[name='"+i.camelize(!1)+"']:not(:file)"),h.length>0&&(h.is(":checkbox")?c?h.attr("checked","checked"):h.removeAttr("checked"):h.is(":radio")?h.filter("[value='"+c+"']").attr("checked","checked"):h.val(c)),c instanceof Joosy.Resources.Array){for(l=[],g=j=0,k=c.length;k>j;g=++j)e=c[g],l.push(d(e.data,f.concatFieldName(b,"["+a+"_attributes]["+g+"]")));return l}return c instanceof Joosy.Resources.REST?d(c.data,f.concatFieldName(b,"["+a+"_attributes]")):Object.isObject(c)||Object.isArray(c)?d(c,i):void 0}),delete a.__joosy_form_filler_lock)},d(c,a.__entityName||b.resourceName),$("input[name=_method]",this.$container).remove(),a.id()&&this.__markMethod((null!=b?b.method:void 0)||"PUT"),e=(null!=b?b.action:void 0)||(null!=a.id()?a.memberPath():a.collectionPath()),this.$container.attr("action",e),this.$container.attr("method","POST")},c.prototype.submit=function(){return this.$container.submit()},c.prototype.serialize=function(a){var b;return null==a&&(a=!0),b=this.$container.serialize(),a&&(b=b.replace(/\&?\_method\=put/i,"")),b},c.prototype.__success=function(a,b,c){var d;return c?"function"==typeof this.success?this.success(a):void 0:200<=(d=a.status)&&300>d?this.success(a.json):this.__error(a.json)},c.prototype.__before=function(){return null==this.before||this.before.apply(this,arguments)===!0?this.$fields().removeClass(this.invalidationClass):void 0},c.prototype.__error=function(a){var b,c,d=this;return c=function(){if(!a.responseText)return a;try{return a=jQuery.parseJSON(a.responseText)}catch(c){return b=c,{}}}(),null==this.error||this.error(c)===!0?(c=this.__stringifyErrors(c),Object.each(c,function(a,b){var c;return c=d.findField(a).addClass(d.invalidationClass),"function"==typeof d.notification?d.notification(c,b):void 0}),c):!1},c.prototype.__debounce=function(a){return this.debugAs(this,"debounce: pending_request == "+this.__pending_request),this.__pending_request&&this.debounce!==!1&&(this.debounce||Joosy.Form.debounceForms)?(a.abort(),this.debugAs(this,"debounce: xhr aborted"),!0):!1},c.prototype.findField=function(a){return this.$fields().filter("[name='"+a+"']")},c.prototype.__markMethod=function(a){return null==a&&(a="PUT"),a=$("<input/>",{type:"hidden",name:"_method",value:a}),this.$container.append(a)},c.prototype.__stringifyErrors=function(a){var b,c=this;return b={},Object.isObject(null!=a?a.errors:void 0)&&(a=a.errors),Object.each(a,function(a,d){var e,f,g,h,i;if(null!=c.substitutions[a]&&(a=c.substitutions[a]),Object.isObject(d)||c.isArrayOfObjects(d))return Object.each(c.__foldInlineEntities(d),function(c,d){return b[a+c]=d});if(-1!==a.indexOf("."))for(g=a.split("."),a=g.shift(),(c.resourceName||c.__resource)&&(f=c.resourceName||c.__resource.__entityName,a=f+("["+a+"]")),h=0,i=g.length;i>h;h++)e=g[h],a+="["+e+"]";else(c.resourceName||c.__resource)&&(f=c.resourceName||c.__resource.__entityName,a=f+("["+a+"]"));return b[a]=d}),b},c.prototype.__foldInlineEntities=function(a,b,c){var d=this;return null==b&&(b=""),null==c&&(c={}),Object.each(a,function(a,e){return Object.isObject(e)||d.isArrayOfObjects(e)?d.__foldInlineEntities(e,""+b+"["+a+"]",c):c[""+b+"["+a+"]"]=e}),c},c.prototype.concatFieldName=function(a,b){var c;return c=this.splitFieldName(a).concat(this.splitFieldName(b)),""+c[0]+"["+c.slice(1).join("][")+"]"},c.prototype.splitFieldName=function(a){var b,c;return c=a.split("]["),b=c[0].split("["),2===b.length&&(b[0].isBlank()?c.splice(0,1,b[1]):c.splice(0,1,b[0],b[1]),c[c.length-1]=c[c.length-1].split("]")[0]),c},c.prototype.isArrayOfObjects=function(a){return Object.isArray(a)&&a.every(function(a){return Object.isObject(a)})},c}(Joosy.Module),null!=("undefined"!=typeof define&&null!==define?define.amd:void 0)&&define("joosy/form",function(){return Joosy.Form})}).call(this);